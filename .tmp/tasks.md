
# 要件

すべてNodeBBのプラグインとして実装する
サーバーとの通信はWebSocketを通じて行う

# 完了済み機能

- [x] コミュニティサイドバーの基本実装
- [x] コミュニティフォロー/アンフォロー機能
- [x] コミュニティ一覧表示機能
- [x] サイドバーのトグル機能
- [x] トップレベルカテゴリのフィルタリング

# タスク一覧

- [x] 01: 未ログインだった場合、参加コミュニティ一覧を非表示にする
- [x] 02: 自分がコミュニティオーナーだった場合、コミュニティトップに `Edit` ボタンを設ける
- [x] 03: 自分がコミュニティオーナーだった場合、コミュニティ情報を編集できるモーダルを表示する
  - [x] 03a: コミュニティ名（名前、スラグ、詳細、ロゴ）を編集できる
  - [x] 03b: コミュニティ以下のカテゴリーを編集（追加、削除、編集）できる
  - [x] 03c: メンバーのロール管理を行う（オーナー、マネージャー、メンバー、バン）
- [x] 04: plugins/nodebb-plugin-caiz/libs/community.js が肥大化しているので分割
- [x] 05: 投稿時にAIでモデレーションを行う。しきい値を超える場合、要モデレーションのフラグを立てる
  - [x] 05a: 専用プラグインの作成（基本実装とシンプルな管理画面）
  - [x] 05b: 設定の保存、フォームへの復元、更新
  - [x] 05c: API接続のテスト機能の実装
  - [x] 05d: フィルターの設定（トピック作成、コメント作成、返信）。モデレーションはまだ実装しない
  - [x] 05e: システム管理者用設定画面の作成（APIキーの入力、デフォルト値のしきい値の設定）
  - [x] 05f: モデレーションの実装（判定結果の保存、通知機能の実装）
- 06: モデレーション
  - [x] 06g: コミュニティ（親カテゴリー）作成時に、owner/managerグループに対して当該コミュニティへのモデレート権限（'read', 'topics:read', 'moderate'）を付与する
- [x] フォロー中・未フォローのラベルが逆っぽいので修正
- [x] コミュニティ作成時のデフォルトのサブカテゴリーの説明文、アイコンの変更（ドキュメントのみ）
- [x] 07: メンバーしか書き込み不可
- コミュニティ編集
  - [x] Editにデンジャーゾーン（コミュニティ削除）
- [x] 09: AIサマリー機能の実装（独立プラグイン `nodebb-plugin-ai-topic-summary` として作成）
  - [x] スレッドの流れをAIでまとめて保存する（10スレッドごとに）。
  - [x] スレッドのトップで、AIスレッドの要約を表示する
- [x] スレッドの作成モーダルが左寄りになっている
- [x] スレッドには「フォロー」「フォロー解除」ボタンは不要
- [x] コミュニティ一覧のサイドバーで、画像の場合に何も表示されないので修正
- [x] コミュニティ一覧のサイドバーで、開閉した状態について、ブラウザを再読込しても維持してほしい
- [x] 自分しかコミュニティオーナーがいない場合、メンバーを抜けることは不可
- [x] コミュニティ作成時に `Uncaught (in promise) TypeError: alert is not a function    at Socket.eval (scripts-client.js:2151:17)`
- [x] コミュニティ名に `/` を含むと、コミュニティ作成エラー（実際には作成できている）
- [x] /recent と /popular /unread で、コミュニティ名を表示する
- [x] /communities を2列表示に（画面幅による）
- [x] /communities ではMarkdown禁止に

- [x] 11: categories/categoryに余計なborderがついているので削除

# 第2フェーズ

- 通知設定
  - [x] 12: コミュニティ編集モーダルに通知設定を追加
  - [x] 13: Slack、Discordアプリに必要な設定を管理画面で行えるようにする
  - [x] SlackのOAuth認証
  - [x] 15: DiscordのOAuth認証
  - Slack向けの通知処理
    - [x] 16: 新規トピック
    - [x] 17: 新規コメント
    - [x] 18: 新規メンバー参加
    - [x] 19: メンバー退出
  - Discord向けの通知処理
    - [x] 20: 新規トピック
    - [x] 21: 新規コメント
    - [x] 22: 新規メンバー参加
    - [x] 23: メンバー退出
- 埋め込み
  - [x] 24: URLのOGP表示
  - [x] 25: 正規表現でのURLから埋め込みへの変換
- 自動翻訳
  - [x] 26: 管理画面を追加。プロンプトを編集できる
  - [x] 27: 投稿に合わせて、Gemini APIで自動翻訳（20か国語）を行う
    - 投稿内容・トピックタイトル
  - [x] 29: クエリーストリングに合わせて言語を切り替える（locale=??）
    - htmlタグのヘッダーも変更（<html lang="??"> と <meta name="og:locale" content="??"> と <link rel="alternate" hreflang="ja" href="https://example.com/?lang=??" />）
  - [x] 30: ユーザーのブラウザ設定に基づいて言語を自動的に切り替える
  - [x] 28: 言語切替を右側に追加（ドロップダウン）
- MCPサーバー
  - [x] 32: プラグインの雛形を書く
    - `/api/mcp/health` のみ追加して疎通確認
  - [x] 33: メタデータ公開
    - `/.well-known/oauth-protected-resource` を返す
  - [x] 34: 401とWWW-Authenticate
    - 未認証の `/api/mcp/session` に 401 と `WWW-Authenticate` を返す
  - [x] 35: 認証モジュール骨子
    - Bearer 抽出・401送出の共通化
  - [x] 36: JWT/JWKS 検証
    - `aud/iss/exp` 検証と JWKs 取得
  - [x] 37: 認証済セッション応答
    - 正しいトークンで `/api/mcp/session` が200で基本情報を返す
  - API用トークンの管理
    - [x] 38: ユーザー情報（sidebar/right）にAPIトークンメニューアイコンの追加
    - [x] 39: APIトークン一覧の表示
    - [x] 40: APIトークンの作成、更新、削除
  - [x] SSE 最小実装
    - `GET /api/mcp` で `text/event-stream` を開始、ハートビート送出
  - [x] JSON-RPC 受信の枠
    - `POST /api/mcp` を受けて JSON-RPC フォーマットを検査
  - [x] ツール定義の雛形
    - `tools/list` で利用可能ツール一覧を返す（例: search）
  - [x] 検索ツールの中身
    - `search` が固定データまたは簡易検索を返す
  - OAuth2基盤実装
    - [x] タスク1: OAuth2メタデータエンドポイント
      - `/.well-known/oauth-authorization-server` の実装
      - 必要なOAuth2エンドポイントのメタデータ公開
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/routes/wellknown.js` (新規)
        - `plugins/nodebb-plugin-mcp-server/library.js` (ルート追加)
    - [x] タスク2: Device Authorization Grant実装
      - `/oauth/device_authorization` エンドポイント
      - デバイスコード生成とユーザーコード生成
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/routes/oauth.js` (新規)
        - `plugins/nodebb-plugin-mcp-server/lib/oauth-device.js` (新規)
    - [x] タスク3: ユーザー認証フロー
      - `/oauth/device` ユーザー認証画面
      - デバイスコード検証と承認処理
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/templates/oauth-device.tpl` (新規)
        - `plugins/nodebb-plugin-mcp-server/public/oauth-device.js` (新規)
        - `plugins/nodebb-plugin-mcp-server/routes/oauth.js` (更新)
        - `plugins/nodebb-plugin-mcp-server/languages/*/mcp-server.json` (更新)
  - フェーズ2: トークン管理
    - [x] タスク4: トークンエンドポイント
      - `/oauth/token` エンドポイント実装
      - grant_type: `urn:ietf:params:oauth:grant-type:device_code` サポート
      - アクセストークン・リフレッシュトークン発行
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/lib/oauth-token.js` (更新)
        - `plugins/nodebb-plugin-mcp-server/routes/oauth.js` (更新)
    - [x] タスク5: トークン検証とリフレッシュ
      - リフレッシュトークン処理
      - トークン有効期限管理
      - トークンストレージ（Redis/DB）
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/lib/token-storage.js` (新規)
        - `plugins/nodebb-plugin-mcp-server/lib/oauth-token.js` (更新)
        - `plugins/nodebb-plugin-mcp-server/routes/oauth.js` (更新)
        - `plugins/nodebb-plugin-mcp-server/lib/oauth-clients.js` (新規)
  - フェーズ3: 認証切り替え（修正ファイル: 2〜3個）
    - [x] タスク6: 認証ミドルウェア更新
      - Bearer Token認証とOAuth2認証の共存
      - OAuth2トークンでの認証処理追加
      - SSE接続の堅牢性改善とユーザー識別
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/lib/simple-auth.js` (更新)
        - `plugins/nodebb-plugin-mcp-server/routes/mcp.js` (更新)
    - [x] タスク7: MCP初回接続フロー
      - 未認証時の401応答とOAuth2フロー開始
      - デバイス認証後の自動接続
      - トークン期限監視とリアルタイム通知
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/routes/mcp.js` (更新)
  - フェーズ4: 統合テスト（修正ファイル: 1〜2個）
    - [x] タスク8: Claude Desktop統合
      - `mcp-remote`経由での接続確認
      - OAuth2フロー全体のE2Eテスト
      - エラーハンドリングとリトライ
      - 修正ファイル:
        - `plugins/nodebb-plugin-mcp-server/tests/oauth-flow.js` (新規)
  - コミュニティ名の多言語化
    - [x] 作成時
    - [x] 更新時
    - [x] 表示
  - サブカテゴリーの多言語化
    - [x] 作成時
    - [x] 更新時
    - [x] 表示
  - 検索のElastic対応
    - [x] docker-composeの用意
    - [x] 既存のライブラリのフォーク
    - [x] インデックスの多言語対応（Intl.Segmenter）
    - [x] 検索対応/表示
  - AIサマリーの多言語化
    - [x] サマリー作成時の多言語対応
    - [x] サマリーの表示時の多言語対応
- 追加レンダリング
  - [x] Mermaid
  - [x] MathJax
  - [x] PlantUML
- 表示編集
  - [x] パンくずリストが多言語対応していない
  - [x] 41: パンくずリスト i18n 設計ドキュメント作成（.tmp/tasks/41-breadcrumb-i18n.md）
- コミュニティ編集
  - [x] 参加ルール設定。独自の規約に同意したり、アンケートに答えてもらうなど
  - [x] 42: 参加ルール同意フロー 設計ドキュメント作成（.tmp/tasks/42-community-consent.md）
  - [x] 43: Xへの通知機能 設計ドキュメント作成（.tmp/tasks/43-x-notification.md）
- OGP
  - [ ] 再取得機能
  - [x] 45: OGP再取得機能 設計ドキュメント作成（.tmp/tasks/task-45-ogp-refetch.md）
- バグ修正
  - [ ] 規約のモーダルがコミュニティを表示したタイミングで表示されてしまう（本来はBecome memberを押したとき）
  - [ ] div.topic-info のカテゴリー名が多言語処理されていない
  - [ ] html lang 属性が多言語処理されていない
- MCP機能 ver2
  - [ ] レート制限
    - `POST /mcp/messages` に rps 制限
  - [ ] 逆プロキシ前提のヘッダ/タイムアウト
    - SSE の `Cache-Control` 等ヘッダ固定、タイムアウト注意書き
- Webhook
- 配信
  - [ ] RTMP受信
- 投稿を編集した場合に再翻訳
- 投稿を編集した場合に、再モデレーション
- コミュニティごとの未読表示
- プロフィールの多言語化 https://caiz.dev/user/goofmint/posts
- トピックの多言語化 https://caiz.dev/user/goofmint/topics
- Sentry対応
